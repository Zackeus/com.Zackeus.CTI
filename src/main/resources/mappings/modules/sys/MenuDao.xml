<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.Zackeus.CTI.modules.sys.dao.MenuDao">
	
	<sql id="menuColumns">
		M.[ID],
		M.[PARENT_ID],
      	M.[NAME],
      	M.[ICON],
      	M.[SORT],
      	M.[HREF],
      	M.[SPREAD],
      	M.[CREATE_DATE],
      	M.[UPDATE_DATE],
      	M.[CREATE_BY],
      	M.[UPDATE_BY],
      	M.[REMARKS]
	</sql>
	
	<resultMap type="Menu" id="menuResultMap">
		<id property="id" column="ID" />
		<result property="parentId" column="PARENT_ID" />
		<result property="userId" column="USER_ID" />
		<collection property="children" column="{id = ID, userId = USER_ID}" select="getMenuList"/>
	</resultMap>
	
	<!-- 获取全部菜单列表  -->
	<select id="findAllList" resultType="Menu">
		SELECT
		<include refid="menuColumns"/>
		FROM [Message].[dbo].[SYS_MENU] M
		ORDER BY M.[SORT]
	</select>
	
	<!--  根据用户权限和父级ID查询菜单列表 -->
	<select id="getMenuList" resultMap="menuResultMap">
		SELECT DISTINCT
		<include refid="menuColumns"/>
		<choose>
        	<when test="userId != null and userId == '1'.toString()">
        		,'1' AS [USER_ID]
        		FROM [Message].[dbo].[CTI_MENU] M
            </when>
            <otherwise>
            	,U.id AS [USER_ID]
				FROM [Message].[dbo].[CTI_MENU] M
				JOIN [Message].[dbo].[CTI_ROLE_MENU] RM ON RM.[MENU_ID] = M.[ID]
				JOIN [Message].[dbo].[CTI_ROLE] R ON R.[ID] = RM.[ROLE_ID]
				JOIN [Message].[dbo].[CTI_USER_ROLE] UR ON UR.[ROLE_ID] = r.[ID]
				JOIN [10.5.60.80].[jeesite-yfc].[dbo].[sys_user] U ON U.id = UR.[USER_ID] AND u.id = #{userId}
            </otherwise>
        </choose>
		WHERE M.[PARENT_ID] = #{id}
		ORDER BY [SORT]
	</select>
	
</mapper>